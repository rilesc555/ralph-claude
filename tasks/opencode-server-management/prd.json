{
  "schemaVersion": "2.0",
  "project": "Ralph",
  "taskDir": "tasks/opencode-server-management",
  "branchName": "ralph/opencode-server-management",
  "mergeTarget": null,
  "autoMerge": false,
  "type": "feature",
  "description": "OpenCode Server Management Overhaul - Systemd-managed global server with improved status handling",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix attach status corruption",
      "description": "As a user, I want ralph attach to not mark completed sessions as failed so that my session history remains accurate.",
      "acceptanceCriteria": [
        {
          "description": "When session status is 'stopped' or 'completed', attach prints message without changing status",
          "passes": true
        },
        {
          "description": "Only mark 'failed' when status is 'running' but server healthcheck fails",
          "passes": true
        },
        {
          "description": "Verify status transitions are correct with manual test",
          "passes": true
        },
        {
          "description": "Typecheck passes (uvx ty check src/ralph)",
          "passes": true
        },
        {
          "description": "Lint passes (uv run ruff check src/)",
          "passes": true
        }
      ],
      "priority": 1,
      "passes": true,
      "notes": "Fixed in attach.py: now checks current_status before deciding whether to mark as failed. Sessions in 'stopped' or 'completed' state are left unchanged."
    },
    {
      "id": "US-002",
      "title": "Fix status display for dead servers",
      "description": "As a user, I want ralph status to clearly indicate when a server port is historical vs live so I don't think dead servers are running.",
      "acceptanceCriteria": [
        {
          "description": "Sessions with status 'running' show port normally (e.g., 14096)",
          "passes": true
        },
        {
          "description": "Sessions with status 'stopped'/'completed'/'failed' show dash or no port",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 2,
      "passes": true,
      "notes": "Fixed in session.py format_status_table(): now only shows port for sessions with status='running'."
    },
    {
      "id": "US-003",
      "title": "Add task name resolution",
      "description": "As a user, I want to run 'ralph run my-feature' instead of 'ralph run tasks/my-feature' so that common operations are faster.",
      "acceptanceCriteria": [
        {
          "description": "'ralph run <name>' resolves to 'tasks/<name>/' relative to git root",
          "passes": true
        },
        {
          "description": "Full paths still work (backwards compatible)",
          "passes": true
        },
        {
          "description": "Clear error message if task name not found in tasks/ directory",
          "passes": true
        },
        {
          "description": "Works from any subdirectory of the git repo",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added _resolve_task_dir() and _get_git_root() helpers in cli.py. Tries full path, relative path, then tasks/<name> at git root."
    },
    {
      "id": "US-004",
      "title": "Remove server lifecycle from Ralph",
      "description": "As a developer, I need to remove server start/stop logic from Ralph since systemd now manages the server.",
      "acceptanceCriteria": [
        {
          "description": "Remove OpencodeServer.start() calls from ralph run worker",
          "passes": true
        },
        {
          "description": "Remove server.stop() from worker finally block",
          "passes": true
        },
        {
          "description": "Remove server_pid tracking from sessions table",
          "passes": true
        },
        {
          "description": "Keep server_port in sessions for historical reference",
          "passes": true
        },
        {
          "description": "Simplify opencode_server.py to only keep client/health-check logic",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 4,
      "passes": true,
      "notes": "Refactored opencode_server.py to OpencodeClient class (HTTP-only client). Removed server lifecycle (start/stop/pid tracking). Server is now expected to be managed by systemd on port 14096. cli.py _run_opencode_worker() now uses client.check_server_running() and prints helpful systemctl message if server isn't running. session.py SessionInfo no longer has server_pid field. Pre-existing lint error in branch.py is unrelated."
    },
    {
      "id": "US-005",
      "title": "Connect to systemd-managed server",
      "description": "As a user, I want ralph run to connect to the systemd-managed OpenCode server instead of spawning its own.",
      "acceptanceCriteria": [
        {
          "description": "ralph run checks if opencode.service is running via health check on port 14096",
          "passes": true
        },
        {
          "description": "If server not running, print helpful message with systemctl command",
          "passes": true
        },
        {
          "description": "All HTTP requests include ?directory=<project_root> query parameter",
          "passes": true
        },
        {
          "description": "Project root determined from git root of task directory",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 5,
      "passes": true,
      "notes": "Added _url_with_directory() helper to OpencodeClient that adds ?directory=<project_dir> to all HTTP requests. Updated _run_opencode_worker() to use _get_git_root(task_dir) to properly determine the project root. Health check and systemctl message were already implemented in US-004. Pre-existing lint error in branch.py is unrelated."
    },
    {
      "id": "US-006",
      "title": "Update attach for global server",
      "description": "As a user, I want ralph attach to work after task completion by connecting to the systemd server.",
      "acceptanceCriteria": [
        {
          "description": "Attach connects to port 14096 (systemd server)",
          "passes": true
        },
        {
          "description": "Still passes --session <id> to attach to specific session",
          "passes": true
        },
        {
          "description": "If systemd server not running, print helpful systemctl command",
          "passes": true
        },
        {
          "description": "If session doesn't exist on server, show helpful error",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 6,
      "passes": true,
      "notes": "Refactored _attach_opencode_server() to use DEFAULT_SERVER_PORT (14096) from opencode_server module. Always passes --session <id> to opencode attach. Prints helpful systemctl command if server not running. Shows error if session ID is missing. Removed opencode_server_alive import (now uses check_server_running). Pre-existing lint error in branch.py is unrelated."
    },
    {
      "id": "US-007",
      "title": "Migrate existing database entries",
      "description": "As a user upgrading Ralph, I want my existing session history preserved with the new schema.",
      "acceptanceCriteria": [
        {
          "description": "On first run with new schema, migrate existing sessions table",
          "passes": true
        },
        {
          "description": "Old server_port values preserved as historical data",
          "passes": true
        },
        {
          "description": "Old server_pid column dropped (no longer needed)",
          "passes": true
        },
        {
          "description": "Migration is idempotent (safe to run multiple times)",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 7,
      "passes": true,
      "notes": "Added _drop_server_pid_column() method in session.py that uses SQLite table recreation approach to drop the deprecated server_pid column. Migration runs automatically in _migrate_schema() on first DB connection. All data including server_port values are preserved. Migration is idempotent - checks if column exists before attempting removal. Also fixed pre-existing lint error in branch.py (line too long)."
    },
    {
      "id": "US-008",
      "title": "Update stop and checkpoint commands",
      "description": "As a developer, I need ralph stop and ralph checkpoint to work correctly without server management.",
      "acceptanceCriteria": [
        {
          "description": "ralph stop <task> stops only the task worker via signal file",
          "passes": true
        },
        {
          "description": "Remove any server stop logic from ralph stop",
          "passes": true
        },
        {
          "description": "ralph checkpoint still works (pauses after current iteration)",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 8,
      "passes": true,
      "notes": "Verified stop_session() in session.py already works correctly: for opencode-server sessions it writes a stop signal file and sends SIGTERM to the loop worker process (not the server). For tmux sessions it writes a signal file and sends SIGINT. The opencode server is managed by systemd, not ralph. checkpoint_session() also works correctly by writing a checkpoint signal file that the loop checks between iterations."
    },
    {
      "id": "US-009",
      "title": "Handle attach session targeting",
      "description": "As a user, I want smarter defaults when attaching so I connect to the right session.",
      "acceptanceCriteria": [
        {
          "description": "ralph attach <task> attaches to the most recent session for that task",
          "passes": true
        },
        {
          "description": "ralph attach <task> --session <id> attaches to specific session",
          "passes": true
        },
        {
          "description": "ralph attach (no args) attaches to most recently active session across all tasks",
          "passes": true
        },
        {
          "description": "Typecheck passes",
          "passes": true
        },
        {
          "description": "Lint passes",
          "passes": true
        }
      ],
      "priority": 9,
      "passes": true,
      "notes": "Made task argument optional in cli.py attach_cmd(). Added --session option for explicit opencode session ID targeting. Added _find_most_recent_session() in attach.py that prefers running sessions, then falls back to most recent by started_at. Modified attach() to accept optional task_name and session_id parameters."
    },
    {
      "id": "US-010",
      "title": "Document systemd setup",
      "description": "As a user, I need documentation on setting up the OpenCode systemd service.",
      "acceptanceCriteria": [
        {
          "description": "Add setup instructions to README or docs",
          "passes": true
        },
        {
          "description": "Include the systemd unit file content",
          "passes": true
        },
        {
          "description": "Document commands: systemctl --user enable/start/stop/status opencode",
          "passes": true
        },
        {
          "description": "Explain lingering for persistence across reboots",
          "passes": true
        }
      ],
      "priority": 10,
      "passes": true,
      "notes": "Added 'OpenCode Systemd Setup (Linux)' section to README.md with: complete systemd unit file content, enable/start/stop/status commands in a table, lingering explanation with loginctl command, verification steps (curl health check, journalctl logs). Documentation-only change, typecheck and lint pass."
    }
  ],
  "agent": "opencode"
}
