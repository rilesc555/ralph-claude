{
  "schemaVersion": "2.0",
  "project": "Ralph",
  "taskDir": "tasks/opencode-server-management",
  "branchName": "ralph/opencode-server-management",
  "mergeTarget": null,
  "autoMerge": false,
  "type": "feature",
  "description": "OpenCode Server Management Overhaul - Systemd-managed global server with improved status handling",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix attach status corruption",
      "description": "As a user, I want ralph attach to not mark completed sessions as failed so that my session history remains accurate.",
      "acceptanceCriteria": [
        {
          "description": "When session status is 'stopped' or 'completed', attach prints message without changing status",
          "passes": false
        },
        {
          "description": "Only mark 'failed' when status is 'running' but server healthcheck fails",
          "passes": false
        },
        {
          "description": "Verify status transitions are correct with manual test",
          "passes": false
        },
        {
          "description": "Typecheck passes (uvx ty check src/ralph)",
          "passes": false
        },
        {
          "description": "Lint passes (uv run ruff check src/)",
          "passes": false
        }
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Fix status display for dead servers",
      "description": "As a user, I want ralph status to clearly indicate when a server port is historical vs live so I don't think dead servers are running.",
      "acceptanceCriteria": [
        {
          "description": "Sessions with status 'running' show port normally (e.g., 14096)",
          "passes": false
        },
        {
          "description": "Sessions with status 'stopped'/'completed'/'failed' show dash or no port",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Add task name resolution",
      "description": "As a user, I want to run 'ralph run my-feature' instead of 'ralph run tasks/my-feature' so that common operations are faster.",
      "acceptanceCriteria": [
        {
          "description": "'ralph run <name>' resolves to 'tasks/<name>/' relative to git root",
          "passes": false
        },
        {
          "description": "Full paths still work (backwards compatible)",
          "passes": false
        },
        {
          "description": "Clear error message if task name not found in tasks/ directory",
          "passes": false
        },
        {
          "description": "Works from any subdirectory of the git repo",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Remove server lifecycle from Ralph",
      "description": "As a developer, I need to remove server start/stop logic from Ralph since systemd now manages the server.",
      "acceptanceCriteria": [
        {
          "description": "Remove OpencodeServer.start() calls from ralph run worker",
          "passes": false
        },
        {
          "description": "Remove server.stop() from worker finally block",
          "passes": false
        },
        {
          "description": "Remove server_pid tracking from sessions table",
          "passes": false
        },
        {
          "description": "Keep server_port in sessions for historical reference",
          "passes": false
        },
        {
          "description": "Simplify opencode_server.py to only keep client/health-check logic",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Connect to systemd-managed server",
      "description": "As a user, I want ralph run to connect to the systemd-managed OpenCode server instead of spawning its own.",
      "acceptanceCriteria": [
        {
          "description": "ralph run checks if opencode.service is running via health check on port 14096",
          "passes": false
        },
        {
          "description": "If server not running, print helpful message with systemctl command",
          "passes": false
        },
        {
          "description": "All HTTP requests include ?directory=<project_root> query parameter",
          "passes": false
        },
        {
          "description": "Project root determined from git root of task directory",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Update attach for global server",
      "description": "As a user, I want ralph attach to work after task completion by connecting to the systemd server.",
      "acceptanceCriteria": [
        {
          "description": "Attach connects to port 14096 (systemd server)",
          "passes": false
        },
        {
          "description": "Still passes --session <id> to attach to specific session",
          "passes": false
        },
        {
          "description": "If systemd server not running, print helpful systemctl command",
          "passes": false
        },
        {
          "description": "If session doesn't exist on server, show helpful error",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Migrate existing database entries",
      "description": "As a user upgrading Ralph, I want my existing session history preserved with the new schema.",
      "acceptanceCriteria": [
        {
          "description": "On first run with new schema, migrate existing sessions table",
          "passes": false
        },
        {
          "description": "Old server_port values preserved as historical data",
          "passes": false
        },
        {
          "description": "Old server_pid column dropped (no longer needed)",
          "passes": false
        },
        {
          "description": "Migration is idempotent (safe to run multiple times)",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Update stop and checkpoint commands",
      "description": "As a developer, I need ralph stop and ralph checkpoint to work correctly without server management.",
      "acceptanceCriteria": [
        {
          "description": "ralph stop <task> stops only the task worker via signal file",
          "passes": false
        },
        {
          "description": "Remove any server stop logic from ralph stop",
          "passes": false
        },
        {
          "description": "ralph checkpoint still works (pauses after current iteration)",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Handle attach session targeting",
      "description": "As a user, I want smarter defaults when attaching so I connect to the right session.",
      "acceptanceCriteria": [
        {
          "description": "ralph attach <task> attaches to the most recent session for that task",
          "passes": false
        },
        {
          "description": "ralph attach <task> --session <id> attaches to specific session",
          "passes": false
        },
        {
          "description": "ralph attach (no args) attaches to most recently active session across all tasks",
          "passes": false
        },
        {
          "description": "Typecheck passes",
          "passes": false
        },
        {
          "description": "Lint passes",
          "passes": false
        }
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Document systemd setup",
      "description": "As a user, I need documentation on setting up the OpenCode systemd service.",
      "acceptanceCriteria": [
        {
          "description": "Add setup instructions to README or docs",
          "passes": false
        },
        {
          "description": "Include the systemd unit file content",
          "passes": false
        },
        {
          "description": "Document commands: systemctl --user enable/start/stop/status opencode",
          "passes": false
        },
        {
          "description": "Explain lingering for persistence across reboots",
          "passes": false
        }
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    }
  ],
  "agent": "opencode"
}
