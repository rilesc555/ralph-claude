{
  "project": "ralph-claude",
  "taskDir": "tasks/ralph-tui",
  "branchName": "ralph/ralph-tui",
  "type": "feature",
  "description": "Ralph TUI - Interactive terminal interface with embedded Claude Code session, statistics dashboard, and modal interaction",
  "userStories": [
    {
      "id": "US-001",
      "title": "Split ralph.sh into non-interactive and legacy interactive versions",
      "description": "As a developer, I need to separate the clean Ralph loop from the tmux interactive code so we have a clean foundation.",
      "acceptanceCriteria": [
        { "description": "Create ralph-i.sh containing the current tmux-based interactive functionality", "passes": true },
        { "description": "Remove all tmux/interactive code from ralph.sh (lines related to -I flag, tmux sessions, spinner UI for interactive mode)", "passes": true },
        { "description": "ralph.sh only supports non-interactive mode (remove -I/--interactive flag)", "passes": true },
        { "description": "ralph-i.sh works exactly as current ralph.sh -I does", "passes": true },
        { "description": "Update usage/help text in both scripts", "passes": true },
        { "description": "Both scripts tested and functional", "passes": true }
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Initialize Rust project with ratatui and dependencies",
      "description": "As a developer, I need a Rust project structure with the necessary dependencies for building the TUI.",
      "acceptanceCriteria": [
        { "description": "Create ralph-tui/ directory in project root", "passes": true },
        { "description": "Initialize Cargo project with appropriate metadata", "passes": true },
        { "description": "Add dependencies: ratatui, crossterm, portable-pty, tokio, serde, serde_json", "passes": true },
        { "description": "Create basic main.rs that initializes terminal and shows 'Hello Ralph' then exits cleanly", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true },
        { "description": "Binary runs without errors", "passes": true }
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Implement basic two-panel layout",
      "description": "As a user, I want to see a split-screen layout with Ralph status on the left and Claude area on the right.",
      "acceptanceCriteria": [
        { "description": "Left panel (30% width) shows 'Ralph Status' header", "passes": true },
        { "description": "Right panel (70% width) shows 'Claude Code' header", "passes": true },
        { "description": "Bottom bar shows keybinding hints", "passes": true },
        { "description": "Panels have visible borders", "passes": true },
        { "description": "Layout resizes correctly when terminal is resized", "passes": true },
        { "description": "Press 'q' to quit cleanly", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement PTY subprocess management",
      "description": "As a developer, I need to spawn Claude Code in a pseudo-terminal so we can capture and display its full terminal output.",
      "acceptanceCriteria": [
        { "description": "Use portable-pty to create a PTY pair", "passes": true },
        { "description": "Spawn a simple command (e.g., bash) as proof of concept", "passes": true },
        { "description": "Capture stdout from PTY and store in buffer", "passes": true },
        { "description": "PTY properly cleaned up on exit", "passes": true },
        { "description": "Handle PTY resize when terminal resizes", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Render PTY output in Claude panel",
      "description": "As a user, I want to see the Claude Code terminal output rendered in the right panel.",
      "acceptanceCriteria": [
        { "description": "PTY output displayed in right panel with proper scrolling", "passes": true },
        { "description": "ANSI escape codes interpreted (colors, cursor movement, clearing)", "passes": true },
        { "description": "Output updates in real-time as subprocess produces output", "passes": true },
        { "description": "Panel shows most recent output (auto-scroll to bottom)", "passes": true },
        { "description": "Handle terminal control sequences properly (cursor positioning, etc.)", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 5,
      "passes": true,
      "notes": "Used vt100 crate (0.16.2) for proper escape sequence interpretation"
    },
    {
      "id": "US-006",
      "title": "Implement modal input system",
      "description": "As a user, I want to toggle between controlling Ralph and interacting with Claude Code.",
      "acceptanceCriteria": [
        { "description": "Default mode is 'Ralph' mode (focus on left panel)", "passes": true },
        { "description": "Press 'i' or Tab to enter 'Claude' mode (focus on right panel)", "passes": true },
        { "description": "Press Escape to exit 'Claude' mode back to 'Ralph' mode", "passes": true },
        { "description": "Visual indicator shows current mode (highlighted border or mode label)", "passes": true },
        { "description": "In Claude mode, status bar shows 'Press Esc to return to Ralph'", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 6,
      "passes": true,
      "notes": "Mode enum added with Ralph (default) and Claude states. Visual indicators include [ACTIVE] in title and green/bold borders for active panel."
    },
    {
      "id": "US-007",
      "title": "Forward keyboard input to PTY in Claude mode",
      "description": "As a user, I want my keystrokes to go to Claude Code when in Claude mode.",
      "acceptanceCriteria": [
        { "description": "All printable characters forwarded to PTY stdin", "passes": true },
        { "description": "Special keys work: Enter, Backspace, Delete, Arrow keys", "passes": true },
        { "description": "Ctrl+C sends interrupt signal to PTY (not to TUI)", "passes": true },
        { "description": "Tab key works within Claude (not captured by TUI when in Claude mode)", "passes": true },
        { "description": "Escape exits Claude mode (does not forward to PTY)", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 7,
      "passes": true,
      "notes": "Added forward_key_to_pty() function with ANSI escape sequences for special keys, Ctrl/Alt modifiers. Uses MasterPty::take_writer() for PTY input."
    },
    {
      "id": "US-008",
      "title": "Parse prd.json and display story progress",
      "description": "As a user, I want to see which story Ralph is working on and overall progress.",
      "acceptanceCriteria": [
        { "description": "Accept task directory as CLI argument", "passes": true },
        { "description": "Read and parse prd.json from task directory", "passes": true },
        { "description": "Display: description, branch name, total stories, completed stories", "passes": true },
        { "description": "Show current story being worked on (first with passes: false)", "passes": true },
        { "description": "Progress updates when prd.json changes on disk (file watch or polling)", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 8,
      "passes": true,
      "notes": "Added PRD struct with serde deserialization. CLI requires task-directory argument. File watching via notify crate with 1-second poll interval. Left panel shows task description, branch, progress (X/Y stories with percentage), and current story."
    },
    {
      "id": "US-009",
      "title": "Spawn Claude Code with Ralph prompt",
      "description": "As a developer, I need to spawn Claude Code with the Ralph agent prompt instead of a test shell.",
      "acceptanceCriteria": [
        { "description": "Construct prompt from task directory, prd path, progress path, and prompt.md", "passes": true },
        { "description": "Spawn 'claude --dangerously-skip-permissions' with prompt piped to stdin", "passes": true },
        { "description": "Claude Code runs in PTY and output displayed in right panel", "passes": true },
        { "description": "Handle Claude Code exit (iteration complete)", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 9,
      "passes": true,
      "notes": "Uses build_ralph_prompt() to construct prompt from prompt.md and task paths. Spawns via bash -c with temp file to avoid command line length limits. Claude --print mode used for non-interactive output."
    },
    {
      "id": "US-010",
      "title": "Implement iteration loop",
      "description": "As a user, I want Ralph TUI to automatically start the next iteration when Claude completes.",
      "acceptanceCriteria": [
        { "description": "Accept max iterations as CLI argument (default 10)", "passes": true },
        { "description": "When Claude process exits, check for completion signal in output", "passes": true },
        { "description": "If <promise>COMPLETE</promise> found, show completion message and exit", "passes": true },
        { "description": "If not complete and iterations remain, start next iteration automatically", "passes": true },
        { "description": "Display current iteration number (e.g., 'Iteration 3/10')", "passes": true },
        { "description": "2-second delay between iterations (matching ralph.sh behavior)", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 10,
      "passes": true,
      "notes": "Implemented IterationState enum, spawn_claude() for restarting, run_delay() for countdown between iterations. CLI arg -i/--iterations (default 10). Completion signal detection via recent_output buffer."
    },
    {
      "id": "US-011",
      "title": "Track and display elapsed time",
      "description": "As a user, I want to see how long the current iteration and total session have been running.",
      "acceptanceCriteria": [
        { "description": "Display iteration elapsed time (MM:SS format)", "passes": true },
        { "description": "Display total session elapsed time", "passes": true },
        { "description": "Timers update every second", "passes": true },
        { "description": "Timer resets for each new iteration (iteration timer)", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 11,
      "passes": true,
      "notes": "Uses session_start and iteration_start Instant fields. format_duration() formats as MM:SS. iteration_start reset on new iteration."
    },
    {
      "id": "US-012",
      "title": "Parse Claude output for token usage",
      "description": "As a user, I want to see token usage statistics from Claude Code.",
      "acceptanceCriteria": [
        { "description": "Parse Claude Code output for token usage information", "passes": true },
        { "description": "Display input tokens, output tokens, total tokens", "passes": true },
        { "description": "Accumulate totals across iterations", "passes": true },
        { "description": "Update display in real-time as tokens are reported", "passes": true },
        { "description": "Handle cases where token info isn't available", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 12,
      "passes": true,
      "notes": "TokenStats struct with parse_from_output() for parsing. Patterns: 'input tokens', 'output tokens'. Display shows iter tokens (↓↑) and session total. Tokens accumulated on iteration end."
    },
    {
      "id": "US-013",
      "title": "Calculate and display cost estimates",
      "description": "As a user, I want to see estimated costs based on token usage.",
      "acceptanceCriteria": [
        { "description": "Calculate cost based on Claude Sonnet pricing (or configurable model)", "passes": true },
        { "description": "Display cost for current iteration", "passes": true },
        { "description": "Display cumulative cost for session", "passes": true },
        { "description": "Format as currency (e.g., '$0.42')", "passes": true },
        { "description": "Cost updates as token usage updates", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 13,
      "passes": true,
      "notes": "Uses Claude 3.5 Sonnet pricing ($3/M input, $15/M output). TokenStats.calculate_cost() and format_cost() methods added. Cost displays in green next to token counts."
    },
    {
      "id": "US-014",
      "title": "Show recent activity log",
      "description": "As a user, I want to see a summary of recent Claude actions in the status panel.",
      "acceptanceCriteria": [
        { "description": "Parse Claude output for tool calls (Read, Edit, Write, Bash, etc.)", "passes": true },
        { "description": "Display last 5-10 actions in status panel", "passes": true },
        { "description": "Show action type and brief context (e.g., 'Reading src/auth.ts')", "passes": true },
        { "description": "New actions push old ones up (scrolling log)", "passes": true },
        { "description": "Actions timestamped or in order", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 14,
      "passes": true,
      "notes": "Activity struct stores action_type and target. parse_activities() scans output for tool patterns. PtyState.activities Vec stores last 10 activities. Display shows 5 most recent in status panel with bullet points."
    },
    {
      "id": "US-015",
      "title": "Handle progress.txt rotation",
      "description": "As a user, I want the TUI to handle progress file rotation like ralph.sh does.",
      "acceptanceCriteria": [
        { "description": "Check progress.txt line count before each iteration", "passes": false },
        { "description": "If over threshold (configurable, default 300), perform rotation", "passes": false },
        { "description": "Create progress-N.txt with old content", "passes": false },
        { "description": "Create new progress.txt with summary header", "passes": false },
        { "description": "Support --rotate-at CLI argument", "passes": false },
        { "description": "cargo build --release succeeds", "passes": false }
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Graceful error handling and cleanup",
      "description": "As a user, I want the TUI to handle errors gracefully and always restore my terminal.",
      "acceptanceCriteria": [
        { "description": "Catch panics and restore terminal before showing error", "passes": false },
        { "description": "Handle Ctrl+C gracefully (cleanup PTY, restore terminal)", "passes": false },
        { "description": "Handle Claude process crashes (show error, allow retry or quit)", "passes": false },
        { "description": "Handle file read errors (prd.json missing, etc.) with clear messages", "passes": false },
        { "description": "Terminal always restored to normal state on exit", "passes": false },
        { "description": "cargo build --release succeeds", "passes": false }
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Add CLI argument parsing",
      "description": "As a user, I want to configure the TUI via command line arguments.",
      "acceptanceCriteria": [
        { "description": "Parse task directory argument (required, or prompt if missing)", "passes": true },
        { "description": "--iterations / -i for max iterations (default 10)", "passes": true },
        { "description": "--rotate-at for progress rotation threshold (default 300)", "passes": true },
        { "description": "--help shows usage information", "passes": true },
        { "description": "--version shows version", "passes": true },
        { "description": "Invalid arguments show helpful error messages", "passes": true },
        { "description": "cargo build --release succeeds", "passes": true }
      ],
      "priority": 17,
      "passes": true,
      "notes": "Implemented with manual CLI parsing (no clap). Features: find_active_tasks() discovers tasks with prd.json, prompt_task_selection() for interactive selection, prompt_iterations() when -i not provided, prompt_rotation_threshold() when progress.txt is near threshold. Supports -y/--yes to skip prompts."
    },
    {
      "id": "US-018",
      "title": "Create installation and build instructions",
      "description": "As a user, I want clear instructions for building and using the TUI.",
      "acceptanceCriteria": [
        { "description": "Add build instructions to README.md", "passes": false },
        { "description": "Document all CLI arguments", "passes": false },
        { "description": "Provide example usage commands", "passes": false },
        { "description": "Note Rust toolchain requirements", "passes": false },
        { "description": "Add to project's existing documentation structure", "passes": false }
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    }
  ]
}
